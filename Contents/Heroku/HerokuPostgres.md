---
layout: default
title: ":cloud: クラウド、Heroku"
description: ":cloud: HerokuでのPostgreSQLの操作"
date: "2019/10/11"
lastmod: "2020/05/17"
---

## 0. はじめに

HerokuCLIがインストールされている事。  
HerokuのPostgreSQLへHeroku CLIで接続するにはPSQLを使う様でローカルにPostgreSQLがインストールされている必要がある。  
また、PSQLのコマンドを使うのでシステム環境変数のPathを通しておく。

    $ heroku pg:psql
    --> Connecting to postgresql-dimensional-xxxxx
     !    The local psql command could not be located. For help installing psql, see
     !    https://devcenter.heroku.com/articles/heroku-postgresql#local-setup

## データベース情報を見る

    $ heroku pg:info
    === DATABASE_URL
    Plan:                  Hobby-dev
    Status:                Available
    Connections:           0/20
    PG Version:            10.6
    Created:               2019-02-19 12:06 UTC
    Data Size:             7.8 MB
    Tables:                1
    Rows:                  9/10000 (In compliance)
    Fork/Follow:           Unsupported
    Rollback:              Unsupported
    Continuous Protection: Off
    Add-on:                postgresql-dimensional-xxxxx

## アプリごとのデータベース情報を見る  
PG Versionを見るとデータベースのバージョンを見ることができます。  

    $ heroku pg:info -a <アプリ名>
    === DATABASE_URL
    Plan:                  Hobby-dev
    Status:                Available
    Connections:           10/20
    PG Version:            11.15
    Created:               2019-05-11 12:38 UTC
    Data Size:             8.4 MB/1.00 GB (In compliance)
    Tables:                2
    Rows:                  4/10000 (In compliance)
    Fork/Follow:           Unsupported
    Rollback:              Unsupported
    Continuous Protection: Off
    Add-on:                postgresql-tapered-xxxxx

## 接続情報

    $ heroku config --app <アプリ名>
    === <アプリ名> Config Vars
    DATABASE_URL: postgres://<ユーザー名>:長いパスワード@<AmazonAwsのホスト名>:5432/<データベース名>

Herokuサイトへログインしてからも見れる。  
プルダウンメニューのDataのDataStoresタブを選びアドオン名をクリック。  
Settingsタブを選びDatabase CredentialsのViewCredentialsボタンで表示し見る事ができる。  

<br />

## 1. PostgreSQLへ接続

※ローカルGitのリポジトリで`git remote add heroku ～`が登録されておりその作業ディレクトリで実行する事。  
作業ディレクトリ外では、エラーが発生します。  

    $ heroku pg:psql
    --> Connecting to postgresql-dimensional-xxxxx
    psql (11.3、サーバ 10.6 (Ubuntu 10.6-1.pgdg16.04+1))
    SSL 接続 (プロトコル: TLSv1.2、暗号化方式: ECDHE-RSA-AES256-GCM-SHA384、ビット長: 256、圧縮: オフ)
    "help" でヘルプを表示します。
    <アプリ名>::DATABASE=>

<br />

## 2. PostgreSQLのテーブル一覧を表示

    <アプリ名>::DATABASE=> \d
                   リレーション一覧
     スキーマ | 名前  |    型    |     所有者
    ----------+-------+----------+----------------
     public   | ticks | テーブル | <ユーザー名>
    (1 行)

<br />

## 3. PostgreSQLのテーブルのフィールド、型を表示

    <アプリ名>::DATABASE=> \d <テーブル名>
                                        テーブル"public.shohindata"
         列     |           型           | 照合順序 | Null 値を許容 |            デフォルト
    ------------+------------------------+----------+---------------+----------------------------------
     numid      | integer                |          | not null      | generated by default as identity
     editdate   | numeric(8,0)           |          | not null      |
     edittime   | numeric(6,0)           |          | not null      |
     note       | character varying(255) |          |               |
     shohinnum  | smallint               |          | not null      |
     shohinname | character(50)          |          |               |
    インデックス:
        "shohindata_pkey" PRIMARY KEY, btree (numid)

<br />

## 4. テーブル内の一覧を表示

SQL文のselectですが、末尾に`;`マークを忘れない事。  
忘れると表示できないので`;`マークを入力しEnterキーを押し一度syntax errorを発生させて改めて入力します。  

    <アプリ名>::DATABASE=> select * from <テーブル名>;
     numid | editdate | edittime |          note          | shohinnum |                     shohinname
    -------+----------+----------+------------------------+-----------+----------------------------------------------------
         1 | 20190417 |   203145 | 瀬戸内レモンです       |      7500 | ｾﾄｳﾁﾚﾓﾝ
         2 | 20050923 |   102532 | 果汁100%の炭酸飲料です |      2840 | ﾘﾝｺﾞｼﾞｭｰｽ
         3 | 20160716 |    91103 | 200ml増量です          |      1580 | ｶﾌｪｵﾚ
         4 | 20080825 |   141520 | none                   |       270 | ｳﾒｵﾆｷﾞﾘ
    (4 行)

<br />

## 5. PostgreSQLの接続を終了

`Ctrlキー + Cキー`で終了できます。  

    <アプリ名>::DATABASE=> \q
    バッチ ジョブを終了しますか (Y/N)? y

* * *
